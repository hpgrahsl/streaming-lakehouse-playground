name: streaming-lakehouse-playground
services:
  coordinator-server:
    image: apache/fluss:0.8.0-incubating
    command: coordinatorServer
    depends_on:
      - zookeeper
    environment:
      - |
        FLUSS_PROPERTIES=
        zookeeper.address: zookeeper:2181
        bind.listeners: FLUSS://coordinator-server:9123
        remote.data.dir: /tmp/fluss/remote-data
        datalake.format: lance
        datalake.lance.warehouse: s3://fluss-lakehouse
        datalake.lance.region: us-east-1
        datalake.lance.endpoint: http://minio:9000
        datalake.lance.allow_http: true
        datalake.lance.access_key_id: admin
        datalake.lance.secret_access_key: minio12345
  tablet-server:
    image: apache/fluss:0.8.0-incubating
    command: tabletServer
    depends_on:
      - coordinator-server
    environment:
      - |
        FLUSS_PROPERTIES=
        zookeeper.address: zookeeper:2181
        bind.listeners: FLUSS://tablet-server:9123
        data.dir: /tmp/fluss/data
        remote.data.dir: /tmp/fluss/remote-data
        kv.snapshot.interval: 0s
        datalake.format: lance
        datalake.lance.warehouse: s3://fluss-lakehouse
        datalake.lance.region: us-east-1
        datalake.lance.endpoint: http://minio:9000
        datalake.lance.allow_http: true
        datalake.lance.access_key_id: admin
        datalake.lance.secret_access_key: minio12345
  zookeeper:
    restart: always
    image: zookeeper:3.9.2
  jobmanager:
    build: ./flink/custom_image
    hostname: jobmanager
    ports:
      - "8083:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
    volumes:
      - ./flink/sql/sql-client-jobs.sh:/opt/sql-client/sql-client-jobs
      - ./flink/sql/init.sql:/opt/sql-client/sql/init.sql
      - ./flink/sql/run.sql:/opt/sql-client/sql/run.sql
  taskmanager:
    build: ./flink/custom_image
    hostname: taskmanager
    depends_on:
      - jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 10
        taskmanager.memory.process.size: 2048m
        taskmanager.memory.framework.off-heap.size: 256m

  lancedb-api-server:
    build: ./lancedb-api-server
    hostname: lancedb-api-server
    ports:
      - "8000:8000"
    environment:
      - LANCEDB_URI=s3://fluss-lakehouse/fluss
      - LANCEDB_REGION=us-east-1
      - LANCEDB_ENDPOINT=http://minio:9000
      - LANCEDB_ALLOW_HTTP=true
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=minio12345
  minio:
    hostname: minio
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - ./data/minio:/data
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=minio12345
  minio-bucket-init:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://minio:9000 admin minio12345;
      /usr/bin/mc mb myminio/fluss-lakehouse;
      /usr/bin/mc anonymous set public myminio/fluss-lakehouse;
      "
